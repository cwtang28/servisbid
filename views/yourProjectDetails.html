<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>{{ user }}</title>
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>
</head>

<style>
    table{
        border-collapse: collapse;
        width:100%;
        table-layout: fixed;
    }

    table td {
        width: 20%;
    }
    button#accept{
        width:100%;
    }
</style>

<body style="overflow-x: hidden; overflow-y: hidden;">
    <a href="/profile"> <button> back </button> </a>
    <header>
        <h1>{{ user }} </h1>
        <h3 style="color:gray">{{ category }} </h3>
        <p style="color:gray"> {{ location }} </p>
        <hr>
    </header>
    <h4> {{ service }} </h4>
    <p>{{ description }}</p>
    <p> ${{ highestbid }} </p>

    <a style="display:none" href="/profile" id="done"></a>

    <label> currentBids </label>
    <table id="bidsTable" border="1"><tr> <td>name</td> <td> value </td> <td> comments </td> <td> accept offer</td></table>
</body>

<script>
    var name = "{{ user }}";
    var category = "{{ category }}";
    var userLocation = "{{ location }}";

    var service = "{{ service }}";
    var highestbid = "{{ highestbid }}";
    var description = "{{ description }}";
    
    var tempKey = "{{ key }}";
    var projKeyArray = tempKey.split(',');
    var projKey = projKeyArray[0];
    var creator = "{{ creator }}";
    var creatorEmail = "";

    var config = {
        apiKey: "AIzaSyBljIAXQPP9f9FJ9LTHuVlZJZkpajvmZj4",
        authDomain: "yodelbackend.firebaseapp.com",
        databaseURL: "https://yodelbackend.firebaseio.com",
        storageBucket: "yodelbackend.appspot.com",
        messagingSenderId: "609174959546"
    };
    var userId = "";
    firebase.initializeApp(config);

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            userId = firebase.auth().currentUser.uid;
        }
    })

    var keys=[];
    
    console.log(creator);
    var query = firebase.database().ref("users/" + creator).orderByKey();
    query.once("value")
    .then(function(snapshot) {
        console.log(snapshot.val()["email"])
        creatorEmail = snapshot.val()["email"];
        console.log("got here")
    });

    var query = firebase.database().ref("projects/" + projKey + '/bids').orderByKey();
    query.once("value")
    .then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            var tempkey = childSnapshot.key;

            keys.push(tempkey);
        });

        var names = [];
        var bidValues = [];
        var comments = [];
        var userIds = [];
        firebase.database().ref('/projects' + '/' + projKey + '/bids').once('value').then(function(snapshot) {
            console.log(projKey)
            console.log(snapshot.numChildren())
            for (var x=0; x < snapshot.numChildren(); x++){
                console.log(keys[x]);
                console.log('users/' + snapshot.val()[keys[x]]["user"] + '/username')

                var bidValue = snapshot.val()[keys[x]]["bid"];
                var comment = snapshot.val()[keys[x]]["comments"];
                bidValues.push(bidValue);
                comments.push(comment);
                firebase.database().ref('users/' + snapshot.val()[keys[x]]["user"]).once('value').then(function(snapshot2){
                    var username = snapshot2.val()["username"];
                    console.log(snapshot2.key)
                    userIds.push(snapshot2.key);
                    names.push(username);
                })
            }

        })
        window.setTimeout( function(){

            // console.log(names.length)
            for (var x = 0; x < names.length; x++){
            var table = document.getElementById("bidsTable");
            var row = table.insertRow(-1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            
            cell1.innerHTML = names[x]
            cell2.innerHTML = bidValues[x]
            cell3.innerHTML = comments[x]

            cell4.innerHTML = '<button id="accept" onclick="acceptBid(\'' + names[x] + ',' + bidValues[x] + ',' + userIds[x] + '\')" value="upvote">Accept</button></form>';

        }}, 2000)
    });

    function acceptBid(name2){
        var realData = name2.split(',');
        var userName = realData[0]
        var bidValue = realData[1]
        var bidder = realData[2];

        var bidderData = {
            bidderId:bidder,
            bidderUserName:userName,
            bidValue:bidValue
        }

        console.log(creatorEmail);

        var postData = {
            name:name,
            acceptedBid:bidderData,
            open:false,
            service: service,
            description:  description,
            category: category,
            location: userLocation,
            highestbid: highestbid,
            creatorId:creator,
            creatorEmail:creatorEmail,
            done:false
        };

        var postKey = firebase.database().ref().child('projects').child(projKey).push().key;

        var updates = {};
        var updates2 = {};
        var updates3 = {};
        console.log(bidder)
        updates['/projects/' + projKey] = postData;
        updates2['/users/' + creator + '/projects/' + projKey] = postData;
        updates3['/users/' + bidder + '/worker/' + projKey] = postData;

        firebase.database().ref().update(updates);
        firebase.database().ref().update(updates2);
        firebase.database().ref().update(updates3);
    }

</script>

</html>
