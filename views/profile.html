<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Profile</title>
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>
</head>

<style>
table{
  border-collapse: collapse;
  width:100%;
}

</style>

<body>
    <label id="username"></label><br>
    <button><a href="/createProject"> New Project</a></button>

    <p style = "margin-top:20px;">Don't have an account? <a href = "/register">Sign Up!</a></p>
    <label> Your Projects</label><br>
    <table id="yourTable" border="1"></table>
    <br><br>

    <label> Projects </label><br>
    <table id="projectsTable" border="1">
    </table>

    <form class="search">
        <input type="text" class="register-input" id="searchProject" placeholder="search">
        <select id="searchType">
            <option value="name">Name</option>
            <option value="category" selected>Category</option>
            <option value="location">Location</option>
        </select>
        <!-- <input type="text" class="register-input" id="search" placeholder="Search"> -->
        <!-- <input tpye="text" class="register-input" id="location" placeholder="Location"> -->
        <p id="error"></p>
        <button type="button" onclick="searchProjects()" value="search" class="register-button">search</button>
        <option></option>
    </form>
    <a href="/login" id="notLoggedIn" style="display:none"> </a>

    <script>
        var config = {
            apiKey: "AIzaSyBljIAXQPP9f9FJ9LTHuVlZJZkpajvmZj4",
            authDomain: "yodelbackend.firebaseapp.com",
            databaseURL: "https://yodelbackend.firebaseio.com",
            storageBucket: "yodelbackend.appspot.com",
            messagingSenderId: "609174959546"
        };
        firebase.initializeApp(config);

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                userId = firebase.auth().currentUser.uid;
                firebase.database().ref('/users/' + userId).once('value').then(function(snapshot) {
                    var username = snapshot.val()["username"];
                    document.getElementById("username").innerHTML = username
                });

                var userKeys = [];
                var query2 = firebase.database().ref("users/" + userId + '/projects').orderByKey();
                query2.once("value")
                .then(function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        var key = childSnapshot.key;
                        console.log(key)
                        userKeys.push(key);
                    });

                    firebase.database().ref('/users/' + userId + '/projects').once('value').then(function(snapshot) {

                        for (var x=0; x < snapshot.numChildren(); x++){
                            console.log(snapshot.val()[userKeys[x]][searchType]);

                            var table = document.getElementById("yourTable");

                            var row = table.insertRow(0);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            var cell4 = row.insertCell(3);
                            var cell5 = row.insertCell(4);
                            var cell6 = row.insertCell(5);

                            cell1.innerHTML = snapshot.val()[userKeys[x]]["name"]
                            cell2.innerHTML = snapshot.val()[userKeys[x]]["category"]
                            cell3.innerHTML = snapshot.val()[userKeys[x]]["location"]
                            cell4.innerHTML = snapshot.val()[userKeys[x]]["service"];
                            cell5.innerHTML = snapshot.val()[userKeys[x]]["lowestBid"]
                            cell6.innerHTML = snapshot.val()[userKeys[x]]["description"]
                        }
                    });
                });
            } 
            else {
                window.location = document.getElementById("notLoggedIn").href
            }
        });
        var keys = [];
        var searchType = document.getElementById("searchType").value

        var query = firebase.database().ref("projects").orderByKey();
        query.once("value")
        .then(function(snapshot) {
            snapshot.forEach(function(childSnapshot) {
                var key = childSnapshot.key;
                console.log(key)
                keys.push(key);
            });

            firebase.database().ref('/projects').once('value').then(function(snapshot) {
                for (var x=0; x < snapshot.numChildren(); x++){
                    var table = document.getElementById("projectsTable");

                    var row = table.insertRow(0);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    var cell5 = row.insertCell(4);
                    var cell6 = row.insertCell(5);

                    cell1.innerHTML = snapshot.val()[keys[x]]["name"]
                    cell2.innerHTML = snapshot.val()[keys[x]]["category"]
                    cell3.innerHTML = snapshot.val()[keys[x]]["location"]
                    cell4.innerHTML = snapshot.val()[keys[x]]["service"];
                    cell5.innerHTML = snapshot.val()[keys[x]]["lowestBid"]
                    cell6.innerHTML = snapshot.val()[keys[x]]["description"]
                }
            });
        });

        function searchProjects(){
            var keys = [];
            var searchType = document.getElementById("searchType").value
            var table = document.getElementById('projectsTable');

            while(table.rows.length > 0) {
                table.deleteRow(0);
            }   

            var query = firebase.database().ref("projects").orderByKey();
            query.once("value")
            .then(function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    var key = childSnapshot.key;
                    console.log(key)
                    keys.push(key);
                });

                firebase.database().ref('/users/' + userId + '/projects').once('value').then(function(snapshot) {
                for (var x=0; x < snapshot.numChildren(); x++){
                    console.log(snapshot.val()[keys[x]][searchType]);
                    // console.log(document.getElementById("category").value)
                    if(snapshot.val()[keys[x]][searchType] == document.getElementById("searchProject").value)  {

                        var table = document.getElementById("projectsTable");

                        var row = table.insertRow(0);
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);
                        var cell5 = row.insertCell(4);
                        var cell6 = row.insertCell(5);

                        cell1.innerHTML = snapshot.val()[keys[x]]["name"]
                        cell2.innerHTML = snapshot.val()[keys[x]]["category"]
                        cell3.innerHTML = snapshot.val()[keys[x]]["location"]
                        cell4.innerHTML = snapshot.val()[keys[x]]["service"];
                        cell5.innerHTML = snapshot.val()[keys[x]]["lowestBid"]
                        cell6.innerHTML = snapshot.val()[keys[x]]["description"]
                    }
                }
            });
            });
        }

    </script>

</body>
</html>
